(()=>{"use strict";const e=async e=>{const{url:t,method:n="GET",body:s=null,headers:i={}}=e,o={method:n,headers:{"Content-Type":"application/json",...i}};s&&(o.body=JSON.stringify(s));try{const e=await fetch(t,o),n=await e.json();return{ok:e.ok,status:e.status,data:n}}catch(e){return console.error("Request failed:",e),{ok:!1,status:0,data:null}}};class t{constructor(){this.baseUrl="https://chatbackend-w37r.onrender.com"}async registerUser(t){return e({url:`${this.baseUrl}/new-user`,method:"POST",body:{name:t}})}}const n=document.getElementById("root");new class{constructor(e){this.container=e,this.api=new t,this.websocket=null,this.currentUser=null,this.renderLoginModal()}init(){this.registerEvents()}renderLoginModal(){this.container.innerHTML='\n      <div class="modal__form active">\n        <div class="modal__background"></div>\n        <div class="modal__content">\n          <div class="modal__header">Выберите псевдоним</div>\n          <div class="modal__body">\n            <form id="login-form" class="form">\n              <div class="form__group">\n                <input type="text" class="form__input" id="nickname-input" required autocomplete="off" />\n                <div class="form__hint" id="login-hint"></div>\n              </div>\n            </form>\n          </div>\n          <div class="modal__footer">\n            <button type="submit" form="login-form" class="modal__ok">Продолжить</button>\n          </div>\n        </div>\n      </div>\n    '}renderChat(){this.container.innerHTML='\n      <div class="container">\n        <div class="chat__container">\n          \x3c!-- Левая панель с сотрудниками --\x3e\n          <div class="chat__employees-sidebar" id="employees-list">\n            <div class="chat__employees-header">Employees</div>\n          </div>\n          \n          \x3c!-- Правая панель с чатом --\x3e\n          <div class="chat__area">\n            <div class="chat__messages-container" id="messages-list">\n            </div>\n            <div class="chat__messages-input">\n              <form id="message-form" style="width: 100%;">\n                <div class="form__group">\n                  <input type="text" id="message-input" \n                         class="form__input" \n                         placeholder="Type your message..." \n                         autocomplete="off" />\n                </div>\n              </form>\n            </div>\n          </div>\n        </div>\n      </div>\n    '}registerEvents(){this.container.addEventListener("submit",(e=>{"login-form"===e.target.id?(e.preventDefault(),this.onEnterChatHandler()):"message-form"===e.target.id&&(e.preventDefault(),this.sendMessage())})),this.container.addEventListener("keypress",(e=>{"Enter"===e.key&&"nickname-input"===e.target.id&&(e.preventDefault(),this.onEnterChatHandler())}))}async onEnterChatHandler(){const e=document.getElementById("nickname-input"),t=document.getElementById("login-hint"),n=e?.value?.trim();if(!n)return void(t&&(t.textContent="Nickname cannot be empty"));const s=await this.api.registerUser(n);if(s?.ok&&"ok"===s.data?.status)this.currentUser=s.data.user,this.renderChat(),this.connectWebSocket(),window.addEventListener("beforeunload",(()=>this.sendExit()));else{const e=s?.data?.message||"Registration failed";t&&(t.textContent=e)}}connectWebSocket(){this.websocket=new WebSocket("ws://localhost:3000"),this.websocket.onopen=()=>{console.log("✅ WebSocket connected to backend")},this.websocket.onmessage=e=>{let t;try{t=JSON.parse(e.data)}catch(t){return void console.error("Invalid JSON from server:",e.data)}Array.isArray(t)?this.updateUserList(t):"send"===t.type&&this.renderMessage(t)},this.websocket.onerror=e=>{console.error("❌ WebSocket connection error:",e)}}updateUserList(e){const t=document.getElementById("employees-list");if(!t)return void console.warn("Employees list container not found");if(t.innerHTML='<div class="chat__employees-header">Employees</div>',0===e.length){const e=document.createElement("div");return e.className="employee__container",e.textContent="No employees online",void t.append(e)}if(this.currentUser){const e=document.createElement("div");e.className="employee__container",e.innerHTML=`\n        <div class="employee__name">You (${this.currentUser.name})</div>\n        <div class="employee__status employee__status-online">● Online</div>\n      `,t.append(e)}e.forEach((e=>{if(this.currentUser&&e.id===this.currentUser.id)return;const n=document.createElement("div");n.className="employee__container",n.innerHTML=`\n        <div class="employee__name">${e.name}</div>\n        <div class="employee__status employee__status-online">● Online</div>\n      `,t.append(n)}));const n=document.createElement("div");n.className="employee__status",n.style.marginTop="15px",n.style.fontSize="11px",n.style.textAlign="center",n.textContent=`Updated: ${(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`,t.append(n)}renderMessage(e){const t=document.getElementById("messages-list"),n=this.currentUser&&e.user.id===this.currentUser.id,s=document.createElement("div");s.className=n?"message__container message__container-yourself":"message__container message__container-interlocutor";const i=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});s.innerHTML=`\n      <div class="message__header">${n?"You":e.user.name}</div>\n      <div>${e.message}</div>\n      <div class="message__time">${i}</div>\n    `,t.append(s),t.scrollTop=t.scrollHeight}sendMessage(){const e=document.getElementById("message-input"),t=e?.value?.trim();if(!t||!this.currentUser)return;if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)return void console.warn("WebSocket is not ready. Current state:",this.websocket?.readyState);const n={type:"send",message:t,user:this.currentUser};this.websocket.send(JSON.stringify(n)),e.value=""}sendExit(){this.websocket&&this.websocket.readyState===WebSocket.OPEN&&this.currentUser&&this.websocket.send(JSON.stringify({type:"exit",user:this.currentUser}))}}(n).init()})();